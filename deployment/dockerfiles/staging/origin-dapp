# Origin-js build
FROM node:9 as origin-js-build
WORKDIR /app
COPY ./origin-js /app

RUN npm install
RUN npm run build

# Origin-dapp build with previously built origin-js
FROM node:9 as build
WORKDIR /app
COPY ./origin-dapp /app

ENV BRIDGE_SERVER_DOMAIN bridge.staging.originprotocol.com
ENV BRIDGE_SERVER_PROTOCOL https
ENV IPFS_DOMAIN ipfs.staging.originprotocol.com
ENV IPFS_GATEWAY_PORT 443
ENV IPFS_GATEWAY_PROTOCOL https
ENV PROVIDER_URL https://rinkeby.infura.io/emIXjs9eDuy57IlTYsIP
ENV MESSAGING_NAMESPACE staging
ENV NODE_ENV production

COPY --from=origin-js-build /app/ /usr/local/lib/node_modules/origin/
RUN npm link origin
RUN npm install
RUN npm run build

# Nginx to service static files
FROM nginx:1.15.2
COPY --from=build /app/build /usr/share/nginx/html
CMD ["nginx", "-g", "daemon off;"]
